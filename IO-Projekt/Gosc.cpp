//
//
//  Generated by StarUML(tm) C++ Add-In
//
//  @ Project : Untitled
//  @ File Name : Gosc.cpp
//  @ Date : 05.05.2025
//  @ Author : 
//
//


#define STRZALKI -32
#define GORA 72
#define DOL 80
#define LEWO 75
#define PRAWO 77
#define ESC 27
#define ENTER 13



#include "Gosc.h"

Gosc::Gosc() {
    this->katalog = KatalogDlaGosci::pobierzInstancjeGosc();
}

std::string spacje(int naj);

void Gosc::przegladaj_katalog() 
{
    system("cls");

    std::shared_ptr<Data> data_przyjazdu = std::make_shared<Data>(Data::dzis() + 1);
    std::shared_ptr<Data> data_wymeldowania = std::make_shared<Data>(Data::dzis() + 2);

    bool rysuj = true;
    int wybor = 0;
    int start = 0;
    int ilosc = 10;
    int stop = min(start + ilosc, katalog->get_ilosc_pokoi());
    std::vector<short> indeksy = zastosuj_filtry(*data_przyjazdu, *data_wymeldowania, 0, 1000, 1, "all");
    while (true)
    {
        if (rysuj)
        {
            std::cout << "\033[" << 0 << ";" << 0 << "H";
            std::cout << "ESC - wyjscie z katalogu\n";
            std::cout << "F - wybierz filtry\n";
            std::cout << "ENTER - wybierz pokoj do rezerwacji\n\n";
            std::cout << "Wyswietlam wyniki dla planowanej daty pobytu: " << data_przyjazdu->string() << " - " << data_wymeldowania->string() << "\n\n";
            if (indeksy.size() == 0)
            {
                std::cout << "Brak wynikow :(\n";
            }
            for (int i = start; i < stop; i++)
            {
                std::cout << i << ". " << (wybor == i ? "\033[38;5;0;48;5;15m" : "") << katalog->get_opis(indeksy[i]) << "\x1b[0m          \n";
            }
            rysuj = false;
            //std::cout << start << " " << wybor << " " << stop <<" "<< indeksy.size()<< "        \n";
        }
        switch (Ekran::klawisz()) 
        {
        case STRZALKI:
        {
            rysuj = true;
            switch (Ekran::klawisz())
            {
            case GORA:
            {
                if (wybor)
                {
                    wybor--;
                    if (wybor-start < 1)
                    {
                        if (start > 0)
                        {
                            start--;
                            stop--;
                        }
                    }
                }
                break;
            }
            case DOL:
            {
                if (wybor < indeksy.size()-1)
                {
                    wybor++;
                    if (stop-wybor < 2)  
                    {
                        if (stop < indeksy.size())
                        {
                            start++;
                            stop++;
                        }
                    }
                }
                break;
            }
            default:
                break;
            }
            break;
        }
        case ESC:
        {
            system("cls");
            return;
        }
        case ENTER:
        {
            if (indeksy.size() == 0)
            {
                break;
            }
            zarezerwuj(*data_przyjazdu, *data_wymeldowania, indeksy[wybor]); 
            rysuj = true;
            system("cls");
            indeksy = zastosuj_filtry(*data_przyjazdu, *data_wymeldowania, 0, 1000, 1, "all");
            break;
        }
        case 'f':
        case 'F':
        {
            indeksy = filtruj(data_przyjazdu, data_wymeldowania);
            start = 0;
            wybor = 0;
            stop = min(start + ilosc, indeksy.size());
            rysuj = true;
            system("cls");
            break;
        }
        default:
            break;
        }
    }
}

std::vector<short> polacz_wyniki_filtrow(std::vector<short> v1, std::vector<short> v2)
{
    std::vector<short> wynik;

    for (const auto& p1 : v1)
    {
        for (const auto& p2 : v2)
        {
            if (p1 == p2)
            {
                wynik.push_back(p1);
                break;
            }
        }
    }
    return wynik;
}

std::vector<short> Gosc::filtruj(std::shared_ptr<Data> data_przyjazdu, std::shared_ptr<Data> data_wymeldowania) 
{
    system("cls");
    
    int min_liczba_osob=1;

    int min_cena_noc = 0;
    int max_cena_noc = 1000;
    std::vector<std::string> standard = { "all", "family", "basic", "komfort", "apartament", "deluxe" };
    bool rysuj = true;
    int wybor = 0, wybor_standard=0;
    while (true)
    {
        if (rysuj)
        {
            std::cout << "\033[" << 0 << ";" << 0 << "H";
            std::cout << "R - resetuj wszystkie filtry\n";
            std::cout << "ENTER - zatwierdz filtry\n\n\n";
            std::cout << "Minimalna liczba osob: " << (wybor == 0 ? "\033[38;5;0;48;5;15m" : "") << min_liczba_osob << "\x1b[0m          \n";
            std::cout << "Data przyjazdu: " << (wybor == 1 ? "\033[38;5;0;48;5;15m" : "") << data_przyjazdu->string() << "\x1b[0m          \n";
            std::cout << "Data wymeldowania: " << (wybor == 2 ? "\033[38;5;0;48;5;15m" : "") << data_wymeldowania->string() << "\x1b[0m          \n";
            std::cout << "Minimalna cena za noc: " << (wybor == 3 ? "\033[38;5;0;48;5;15m" : "") << min_cena_noc << "\x1b[0m          \n";
            std::cout << "Maksymalna cena za noc: " << (wybor == 4 ? "\033[38;5;0;48;5;15m" : "") << max_cena_noc << "\x1b[0m          \n";
            std::cout << "Standard: " << (wybor == 5 ? "\033[38;5;0;48;5;15m" : "") << standard[wybor_standard] << "\x1b[0m          \n";
            rysuj = false;
        }
        switch (Ekran::klawisz())
        {
        case STRZALKI:
        {
            rysuj = true;
            switch (Ekran::klawisz())
            {
            case GORA:
            {
                if (wybor)
                    wybor--;
                break;
            }
            case DOL:
            {
                if (wybor < 5)
                    wybor++;
                break;
            }
            case LEWO:
            {
                switch (wybor)
                {
                case 0:
                {
                    if (min_liczba_osob > 1)
                        min_liczba_osob--;
                    break;
                }
                case 1:
                {
                    if (*data_przyjazdu > Data::dzis() + 1)
                    {
                        (*data_przyjazdu)--;
                    }
                    
                    break;
                }
                case 2:
                {
                    if (*data_wymeldowania > *data_przyjazdu + 1)
                    {
                        (*data_wymeldowania)--;
                    }
                    break;
                }
                case 3:
                {
                    if (min_cena_noc > 50)
                        min_cena_noc-=50;
                    break;
                }
                case 4:
                {
                    if (max_cena_noc > 200 && max_cena_noc > min_cena_noc + 50)
                        max_cena_noc-=50;
                    break;
                }
                case 5:
                {
                    if (wybor_standard)
                        wybor_standard--;
                }
                default:
                    break;
                }
                break;
            }
            case PRAWO:
            {
                switch (wybor)
                {
                case 0:
                {
                    if (min_liczba_osob < 6)
                        min_liczba_osob++;
                    break;
                }
                case 1:
                {
                    if (*data_przyjazdu + 1 < *data_wymeldowania)
                        *data_przyjazdu = *data_przyjazdu + 1;
                    break;
                }
                case 2:
                {
                    (*data_wymeldowania)++;
                    break;
                }
                case 3:
                {
                    if (min_cena_noc < 1000 && min_cena_noc + 50 < max_cena_noc)
                        min_cena_noc += 50;
                    break;
                }
                case 4:
                {
                    if (max_cena_noc < 1000)
                        max_cena_noc += 50;
                    break;
                }
                case 5:
                {
                    if (wybor_standard < standard.size()-1)
                        wybor_standard++;
                }
                default:
                    break;
                }
                break;
            }
            default:
                break;
            }
            break;
        }
        case ENTER:
        {
            system("cls");
            return zastosuj_filtry(*data_przyjazdu, *data_wymeldowania, min_cena_noc, max_cena_noc, min_liczba_osob, standard[wybor_standard]);
        }
        case 'r':
        case 'R':
        {
            data_przyjazdu = std::make_shared<Data>(Data::dzis() + 1);
            data_wymeldowania = std::make_shared<Data>(Data::dzis() + 2);
            return zastosuj_filtry(*data_przyjazdu, *data_wymeldowania, 0, 1000, 1, "all");
        }
        default:
            break;
        }
    }

}

std::vector<short> Gosc::zastosuj_filtry(Data data_przyjazdu, Data data_wymeldowania, int min_cena_noc, int max_cena_noc, int min_liczba_osob, std::string standard)
{
    std::vector<short> wyniki;
    auto v1 = katalog->filtruj_wg_ceny(min_cena_noc, max_cena_noc);
    auto v2 = katalog->filtruj_wg_ilosci_osob(min_liczba_osob);
    auto v3 = katalog->filtruj_wg_standardu(standard);
    wyniki = polacz_wyniki_filtrow(v1, v2);
    wyniki = polacz_wyniki_filtrow(wyniki, v3);
    for (Data d = data_przyjazdu; d <= data_wymeldowania; d++)
    {
        auto v4 = katalog->filtruj_wg_daty(d);
        wyniki = polacz_wyniki_filtrow(wyniki, v4);
    }
    return wyniki;
}


void Gosc::zarezerwuj(Data data_przyjazdu, Data data_wymeldowania, int pokoj)
{
    system("cls");
    bool rysuj = true;
    std::vector<short> uslugi;
    double uslugi_cena = 0;
    while (true)
    {
        if (rysuj)
        {
            for (int i = 0; i < uslugi.size(); i++) {
                uslugi_cena += katalog->get_cena_uslugi(uslugi[i]);
            }
            std::cout << "\033[" << 0 << ";" << 0 << "H";
            std::cout << "D - wybierz uslugi dodatkowe\n";
            std::cout << "ESC - anuluj rezerwacje\n";
            std::cout << "ENTER - potwierdz rezerwacje\n\n";
            std::cout << "TWOJA REZERWACJA:\n-----------------------------------\n" << Data::data_na_string(data_przyjazdu) << " - " << Data::data_na_string(data_wymeldowania) << "\n";
            std::cout << "Pokoj nr " << katalog->get_numer(pokoj) << "\nIlosc dodatkowych uslug: " << uslugi.size() << "\n";
            std::cout << "Cena laczna: " << katalog->get_cena(pokoj) + uslugi_cena << "\n";
            rysuj = false;
        }
        switch (Ekran::klawisz())
        {
        case ESC:
        {
            return;
        }
        case 'd':
        case 'D':
        {
            uslugi = dobierz_uslugi();
            rysuj = true;
            break;
        }
        case ENTER:
        {
            historia_rezerwacji.push_back(katalog->zarezerwuj(this->login, data_przyjazdu, data_wymeldowania, pokoj, uslugi));
            return;
        }
        }
    }
    
}

std::string spacje(int naj) {
    std::string s = "";
    for (int i = 0; i < naj; i++) {
        s += " ";
    }
    return s;
}

std::vector<short> Gosc::dobierz_uslugi()
{
    std::vector<short> wyniki;
    system("cls");
    bool rysuj = true;
    int wybor = 0;
    int start = 0;
    int ilosc = 10;
    int stop = min(start + ilosc, katalog->get_ilosc_uslug());
    std::vector<bool> wybrane(katalog->get_ilosc_uslug(), false);

    int najdluzszy = 0;
    for (int i = 0; i < katalog->get_ilosc_uslug(); i++) {
        if (katalog->get_opis_uslugi(i).length() > najdluzszy) {
            najdluzszy = katalog->get_opis_uslugi(i).length();
        }
    }

    while (true)
    {
        if (rysuj)
        {
            std::cout << "\033[" << 0 << ";" << 0 << "H";
            std::cout << "ESC - powrot do rezerwacji\n";
            std::cout << "ENTER - zaznacz/odznacz usluge\n\n";
            for (int i = start; i < stop; i++)
            {
                std::cout << i << ". " << (wybrane[i] ? "\t[\033[32mX\033[0m]  " : "\t[ ]  ") << (wybor == i ? "\033[38;5;0;48;5;15m" : "") << katalog->get_opis_uslugi(i) <<spacje(najdluzszy - katalog->get_opis_uslugi(i).length() + 4) <<"\x1b[0m                              \n";
            }
            rysuj = false;
            //std::cout << start << " " << wybor << " " << stop <<" "<< indeksy.size()<< "        \n";
        }
        switch (Ekran::klawisz())
        {
        case STRZALKI:
        {
            rysuj = true;
            switch (Ekran::klawisz())
            {
            case GORA:
            {
                if (wybor)
                {
                    wybor--;
                    if (wybor - start < 1)
                    {
                        if (start > 0)
                        {
                            start--;
                            stop--;
                        }
                    }
                }
                break;
            }
            case DOL:
            {
                if (wybor < katalog->get_ilosc_uslug() - 1)
                {
                    wybor++;
                    if (stop - wybor < 2)
                    {
                        if (stop < katalog->get_ilosc_uslug())
                        {
                            start++;
                            stop++;
                        }
                    }
                }
                break;
            }
            default:
                break;
            }
            break;
        }
        case ESC:
        {
            system("cls");
            for (int i = 0; i < wybrane.size(); i++)
            {
                if (wybrane[i])
                    wyniki.push_back(i);
            }
            return wyniki;
        }
        case ENTER:
        {
            if (katalog->get_ilosc_uslug() == 0)
            {
                break;
            }
            rysuj = true;
            wybrane[wybor] = !wybrane[wybor];
            break;
        }
        
        default:
            break;
        }
    }
}

void Gosc::przegladaj_historie_rezerwacji()
{
    system("cls");
    bool rysuj = true;
    int wybor = 0;
    int start = 0;
    int ilosc = 10;
    int stop = min(start + ilosc, historia_rezerwacji.size());

    while (true)
    {
        if (rysuj)
        {
            std::cout << "\033[" << 0 << ";" << 0 << "H";
            std::cout << "ESC - powrot do menu\n";
            std::cout << "ENTER - zobacz szczegoly rezerwacji\n\n";
            if (historia_rezerwacji.size() == 0)
            {
                std::cout << "Brak wynikow :(\n";
            }
            for (int i = start; i < stop; i++)
            {
                std::cout << i << ". " << (wybor == i ? "\033[38;5;0;48;5;15m" : "") << "Rezerwacja: "
                    << Data::data_na_string(historia_rezerwacji[i].get_data_przyjazdu()) << " - " << Data::data_na_string(historia_rezerwacji[i].get_data_wymeldowania())
                    << "\t" << "\x1b[0m          \n";
            }
            rysuj = false;
        }
        switch (Ekran::klawisz())
        {
        case STRZALKI:
        {
            rysuj = true;
            switch (Ekran::klawisz())
            {
            case GORA:
            {
                if (wybor)
                {
                    wybor--;
                    if (wybor - start < 1)
                    {
                        if (start > 0)
                        {
                            start--;
                            stop--;
                        }
                    }
                }
                break;
            }
            case DOL:
            {
                if (wybor < historia_rezerwacji.size() - 1)
                {
                    wybor++;
                    if (stop - wybor < 2)
                    {
                        if (stop < historia_rezerwacji.size())
                        {
                            start++;
                            stop++;
                        }
                    }
                }
                break;
            }
            default:
                break;
            }
            break;
        }
        case ESC:
        {
            system("cls");
            return;
        }
        case ENTER:
        {
            if (historia_rezerwacji.size() == 0)
            {
                break;
            }
            system("cls");
            historia_rezerwacji[wybor].pokaz_szczegoly();
            //TODO: daæ mo¿liwoœæ op³acenia
            system("pause");
            system("cls");
            rysuj = true;
            break;
        }
        default:
            break;
        }
    }
}

void Gosc::gui() {
    
    system("cls");
    int a;
    historia_rezerwacji = Rezerwacja::odczytaj_rezerwacje(login);
    do {
        std::cout << "1. Pokaz katalog pokoi i uslug.\n2. Pokaz historie rezerwacji.\n3. Wyslij wiadomosc.\n4. Zobacz wyslane wiadomosci.\n5. Zobacz odebrane wiadomosci.\n6. Wyloguj sie.\n";
        auto para = Wiadomosc::odczytaj_wiadomosci(this->login);
        this->wyslane_wiadomosci = para.first;
        this->odebrane_wiadomosci = para.second;
        
        std::cin >> a;
        if (std::cin.fail()) {
            std::cin.clear();
            std::cin.ignore(1000, '\n');
        }
        if (a == 1) {
            przegladaj_katalog();
        }
        if (a == 2) {
            przegladaj_historie_rezerwacji();
        }
        if (a == 3) {
            wyslij_wiadomosc();
        }
        if (a == 4) {
            przegladaj_wyslane_wiadomosci();
        }
        if (a == 5) {
            przegladaj_odebrane_wiadomosci();
        }
        if (a == 6) {
            wyloguj();
            break;
        }
    } while (true);
}

